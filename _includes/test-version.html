<script>
//<![CDATA[
    var examples = new Array();
    var vrvToolkit = null;
    var vrvVersion = "1_0";
    var customExample = null;
    
    /////////////////////////////
    ////////// Options //////////
    /////////////////////////////
    
    var defaultOptions_1_0 = {
        adjustPageHeight: 1,
        ignoreLayout: 1,
        pageHeight: 2970,
        pageWidth: 2100,
        scale: 40,
        spacingStaff: 4
    };
    
    // Same as before
    var defaultOptions_1_1 = defaultOptions_1_0;
    
    var defaultOptions_2_0 = {
        adjustPageHeight: "true",
        breaks: "auto",
        pageHeight: 2970,
        pageWidth: 2100,
        noHeader: true,
        noFooter: true,
        scale: 40,
        spacingStaff: 4,
    };
    
    // Same as before
    var defaultOptions_2_1 = defaultOptions_2_0;	
    var defaultOptions_2_2 = defaultOptions_2_1;

    var defaultOptions_2_3 = {
        adjustPageHeight: "true",
        breaks: "auto",
        pageHeight: 2970,
        pageWidth: 2100,
        header: "none",
        footer: "none",
        scale: 40,
        spacingStaff: 4,
    };

    var defaultOptions_2_4 = defaultOptions_2_3;
    var defaultOptions_2_5 = defaultOptions_2_4;
    var defaultOptions_2_6 = defaultOptions_2_5;
    var defaultOptions_2_7 = defaultOptions_2_6;

    var defaultOptions_3_0 = defaultOptions_2_7;
    var defaultOptions_3_1 = defaultOptions_3_0;
    var defaultOptions_3_2 = defaultOptions_3_1;
    var defaultOptions_3_3 = defaultOptions_3_2;
    var defaultOptions_3_4 = defaultOptions_3_3;
    var defaultOptions_3_5 = defaultOptions_3_4;
    var defaultOptions_3_6 = defaultOptions_3_5;
    var defaultOptions_3_7 = defaultOptions_3_6;
    var defaultOptions_3_8 = defaultOptions_3_7;
    var defaultOptions_3_9 = defaultOptions_3_8;
    var defaultOptions_3_10 = defaultOptions_3_9;
    var defaultOptions_3_11 = defaultOptions_3_10;
    var defaultOptions_3_12 = defaultOptions_3_11;
    var defaultOptions_3_13 = defaultOptions_3_12;

    /////////////////////////////
    ///// Loading functions /////
    /////////////////////////////
    
    function loadExample_1_0(data, div, options, page = 1) {
        vrvToolkit.setOptions( options );
        try {
            vrvToolkit.loadData(data);
            $(div + '-meiCode pre').text(vrvToolkit.getMEI(-1, true));
            $(div + '-meiDiv').show();
        }
        catch(err) {
            $(div + '-errLog pre').html(err);
            $(div + '-errDiv').show();
        }
        svg = vrvToolkit.renderPage(page, {});
        $(div).html(svg);
    }
    
    // Same as before
    loadExample_1_1 = loadExample_1_0;
    
    function loadExample_2_0(data, div, options, page = 1) {
        // Reset default options
        defaultOptions = vrvToolkit.getOptions(true);
        vrvToolkit.setOptions( defaultOptions );
        // Set the passed options
        vrvToolkit.setOptions( options );
        try {
            vrvToolkit.loadData(data);
            $(div + '-meiCode pre').text(vrvToolkit.getMEI(-1, true));
            $(div + '-meiDiv').show();
        }
        catch(err) {
            $(div + '-errLog pre').html(err);
            $(div + '-errDiv').show();
        }
        svg = vrvToolkit.renderToSVG(page, {});
        $(div).html(svg);
    }
    
    // Same as before
    loadExample_2_1 = loadExample_2_0;
    loadExample_2_2 = loadExample_2_1;
    loadExample_2_3 = loadExample_2_2;
    loadExample_2_4 = loadExample_2_3;
    loadExample_2_5 = loadExample_2_4;
    loadExample_2_6 = loadExample_2_5;

    function loadExample_2_7(data, div, options, page = 1) {
        let svg = '';
        try {
            // Reset default options
            defaultOptions = vrvToolkit.getOptions(true);
            vrvToolkit.setOptions( defaultOptions );
            // Set the passed options
            vrvToolkit.setOptions( options );
            vrvToolkit.loadData(data);
            $(div + '-meiCode pre').text(data);
            $(div + '-meiDiv').show();
            svg = vrvToolkit.renderToSVG(page, {});
        }
        catch(err) {
            $(div + '-errLog pre').html(err);
            $(div + '-errDiv').show();
        }
        $(div).html(svg);
    }

    loadExample_3_0 = loadExample_2_7;
    loadExample_3_1 = loadExample_3_0;
    loadExample_3_2 = loadExample_3_1;
    loadExample_3_3 = loadExample_3_2;
    loadExample_3_4 = loadExample_3_3;
    loadExample_3_5 = loadExample_3_4;
    loadExample_3_6 = loadExample_3_5;
    loadExample_3_7 = loadExample_3_6;
    loadExample_3_8 = loadExample_3_7;
    loadExample_3_9 = loadExample_3_8;
    loadExample_3_10 = loadExample_3_9;
    loadExample_3_11 = loadExample_3_10;
    loadExample_3_12 = loadExample_3_11;
    loadExample_3_13 = loadExample_3_12;

    /////////////////////////////
    
    function loadExamples() {
        var cat = getParameterByName("cat");
        // no parameter - load what was set in the storage for the comparison
        if (cat === null) cat = localStorage.getItem('testCat');
        for(i in examples) {
            if (examples[i].file.startsWith("tests/" + cat + "/")) {
                $('#example-' + examples[i].id ).show();
                examples[i].load();
            }
        }
    }
    
    function loadCustomFile() {
        console.log(vrvVersion);
        options = window["defaultOptions_" + vrvVersion];
        options.pageWidth = ($("#localStorageFile").width()) * 100 / options.scale ;
        
        if (localStorage['testOptions']) {
            testOptions = JSON.parse(localStorage['testOptions']);
            console.log(testOptions);
            for(var key in testOptions) {
                options[key] = testOptions[key];
                console.log(options[key]);
            }
        }
        page = 1;
        if (localStorage['testPage']) {
            page = localStorage['testPage'];
        }
        
        // load function for the current version
        loadFunction = window["loadExample_" + vrvVersion]; 
        loadFunction(customExample, "#localStorageFile", options, page );
    }

    function onVerovioWasmLoaded() {
        console.log("onVerovioWasmLoaded");
        verovio.module.onRuntimeInitialized = async _ => {
            vrvToolkit = new verovio.toolkit();
            console.log(vrvToolkit.getVersion());
            onLoaded();
        }
    }
     
    function onVerovioLoaded() {
        vrvToolkit = new verovio.toolkit();
        console.log(vrvToolkit.getVersion());
        onLoaded();
    }

    function onLoaded() {
        var strVersion = vrvToolkit.getVersion();
        var arrVersion = strVersion.replace(/[^A-Za-z0-9]/g, ' ').split(' ');
        vrvVersion = arrVersion[0] + '_' + arrVersion[1];
        console.log(vrvVersion);
        var n = strVersion.lastIndexOf('-');
        var commit = strVersion.substring(n + 1);
        $('#loading').hide();
        $('#version').text( "Version " + strVersion );
        $("#version").attr( "href", "http://github.com/rism-digital/verovio/commit/" + commit ) ;

        if (customExample == null) {
            loadExamples();    
        }
        else {
            loadCustomFile();
        }
    }
    
    function getParameterByName(name) {
        var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
        return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
    }
    
    function nsResolver(prefix) {
        return 'http://www.music-encoding.org/ns/mei';
    }

//]]>
</script>

<div class="container-fluid">

    <div class="panel">
        <h2 class="text-center"><span id="loading">Loading ...</span><a href="" id="version"></a></h2>
    </div>
    
    {% assign categories = "" | split: ',' %}
    {% for collection in site.collections %}
        {% if collection.label == "tests" %}
    <div class="panel test-group" id="examples">

        {% for f in collection.files %}
            {% assign id = f.name | remove:'.mei' %}
            <div id="example-{{ id }}" style="display: none;">
                
                <h4 class="test-xmlfile">{{ f.name }}</h4>
                <p id="note-{{ id }}"></p>

                <p>
                    <span id="label-{{ id }}" class="label"></span>
                </p>

                {% assign filePath = f.path | remove_first: "_" %}
                
                <div id="{{ id }}-meiDiv" style="display: none;">
                    <p>
                        <a data-toggle="collapse" data-target="#{{ id }}-meiCode" aria-expanded="false" aria-controls="{{ id }}-meiCode" style="cursor: pointer;">Show MEI</a> | 
                        <a href="{{ site.tests-edit-path }}/{{ f.path }}" target="_blank">Edit in GitHub</a> |
                        <a href="{{ site.tests-verovio-edit-path }}/{{ f.path }}" target="_blank">Open in the Verovio Editor</a>
                    </p>
                </div>

                <div id="{{ id }}"></div>

                <div id="{{ id }}-errDiv" style="display: none;">
                    <div class="alert alert-danger" role="alert" id="{{ id }}-err">Verovio failed to render the MEI file.</div>
                    <a data-toggle="collapse" data-target="#{{ id }}-errLog" aria-expanded="false" aria-controls="{{ id }}-errLog">Show the error log</a>
                    <div class="collapse" id="{{ id }}-errLog">
                        <pre></pre>
                    </div>
                </div>

                <div>
                    <div class="collapse" id="{{ id }}-meiCode">
                        <pre></pre>
                    </div>
                </div>

                <script>
                //<![CDATA[
                    examples.push({
                        id: "{{ id }}",
                        file: "{{ filePath }}",
                        load: function() {
                            $.ajax({
                                url: "{{ filePath }}"
                                , dataType: "text"
                                , success: function(data) {
                                    //console.log(data);
                                    xml = new window.DOMParser().parseFromString(data, "text/xml")
                                    // Get the description from the /notesStmt/annot
                                    var nodes = xml.evaluate("//mei:notesStmt/mei:annot", xml, nsResolver, XPathResult.ANY_TYPE, null);
                                    var result = nodes.iterateNext();
                                    var txt = "";
                                    while (result) {
                                        if (result.childNodes[0]) txt += result.childNodes[0].nodeValue + "<br />";
                                        result = nodes.iterateNext();
                                    }
                                    $('#note-{{ id }}').html(txt);
                                    // Get the version from the /appInfo/application@version
                                    var appVersion = xml.evaluate("//mei:appInfo/mei:application/@version", xml, nsResolver, XPathResult.FIRST_ORDERED_NODE_TYPE, null);
                                    txt = "unknown";
                                    if (appVersion.singleNodeValue) txt = appVersion.singleNodeValue.value;
                                    $('#label-{{ id }}').html(txt);
                                    // Get the status (currently in @n)
                                    var appLabel = xml.evaluate("//mei:appInfo/mei:application/@label", xml, nsResolver, XPathResult.FIRST_ORDERED_NODE_TYPE, null);
                                    txt = "-1";
                                    if (appLabel.singleNodeValue) txt = appLabel.singleNodeValue.value;
                                    switch (txt) {
                                        case ("0"): $('#label-{{ id }}').addClass("label-error"); break;
                                        case ("1"): $('#label-{{ id }}').addClass("label-warning"); break;
                                        case ("2"): $('#label-{{ id }}').addClass("label-success"); break;
                                        default: $('#label-{{ id }}').addClass("label-default");
                                    }

                                    // Get the version from the /appInfo/application@version
                                    var extMetaOptions = xml.evaluate("//mei:meiHead/mei:extMeta/text()", xml, nsResolver, XPathResult.FIRST_ORDERED_NODE_TYPE, null);
                                    fileOptions = "{}";
                                    if (extMetaOptions.singleNodeValue) fileOptions = extMetaOptions.singleNodeValue.data;

                                    // default options for the current version - make a copy
                                    var options = Object.assign({}, window["defaultOptions_" + vrvVersion]);
                                    options.pageWidth = ($("#{{ id }}").width()) * 100 / options.scale ;
                                    // set the file options (if any);
                                    options = Object.assign(options, JSON.parse(fileOptions));
                                    // load function for the current version
                                    loadFunction = window["loadExample_" + vrvVersion];
                                    loadFunction(data, "#{{ id }}", options );
                                }
                            });
                        }
                    });
                //]]>
                </script>
            </div>
        {% endfor %}

    </div>
        {% endif %}
    {% endfor %}

    <div id="localStorageFile"></div>
    
</div>



<script>
    //<![CDATA[
    $(document).ready(function() {

        // Could not find a way to have the Jekyll collection not ordered by name ...
        // Order the divs by hand
        $("#examples > div").sort(function (a, b) {
            return (a.id > b.id);
        }).each(function(){
            var elem = $(this);
            elem.remove();
            console.log(this.id);
            $(elem).appendTo("#examples");
        })
        
        // The default is the latest develop build
        vrv = "{{ site.baseurl }}/javascript/develop/verovio-toolkit-wasm.js";
        
        // Hide the custom file placeholder
        //$(".test-group").last().hide();
        
        var iframe = getParameterByName("iframe");
        // IFrame loading and custom file stored
        if ((iframe != null) && localStorage['testData']) {
            customExample = localStorage['testData'];
            // Swap display
            // $(".test-group").hide();
            // $(".test-group").last().show();
            // Empty the list of examples to load
            examples = [];
        }

        useWasm = true;
        
        // Version in the second frame ?
        if (iframe == "2") {
            if (localStorage['iframe2']) {
                vrv = localStorage['iframe2'];
            }
            else {
                vrv = "{{ site.baseurl }}/javascript/latest/verovio-toolkit.js";
            }
            useWasm = false;
        }
        
        var element = document.createElement("script");
        element.src = vrv;
        document.body.appendChild(element);
        if (useWasm) {
            element.onload = onVerovioWasmLoaded;
        }
        else {
            element.onload = onVerovioLoaded;
        }
    });
    //]]>
</script>
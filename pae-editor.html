---
layout: verovio
verovio-light: true
title: Verovio PAE Editor
active: tools
tools-active: pae-editor
version-footer: true
---
<div class="row">

    <link rel="stylesheet" href="{{ site.baseurl }}/css/jquery.highlight-within-textarea.css" type="text/css" />
    <script src="{{ site.baseurl }}/javascript/highlight/jquery.highlight-within-textarea.js"></script>


    <div class="col-md-3 sidebar-offcanvas" id="sidebar" role="navigation">
        <div class="panel panel-default">
            {% include other-sidebar.html %}
        </div>
    </div>

    <div class="col-md-9">
        <div class="panel-body">
            <div style="overflow-x: scroll; overflow-y: hidden;">
            <table class="keyboard">
                <tr>
                    <td class="keyboard keyboard-center">
                        <div class="btn-group">
                            <button type="button" class="btn btn-default btn-sm" onclick="javascript:onduration(9)">
                              <span class="glyphicon keyboard-00"></span>
                            </button>
                            <button type="button" class="btn btn-default btn-sm" onclick="javascript:onduration(1)">
                              <span class="glyphicon keyboard-01"></span>
                            </button>
                            <button type="button" class="btn btn-default btn-sm" onclick="javascript:onduration(2)">
                              <span class="glyphicon keyboard-02"></span>
                            </button>
                            <button type="button" class="btn btn-default btn-sm" onclick="javascript:onduration(4)">
                              <span class="glyphicon keyboard-04"></span>
                            </button>
                            <button type="button" class="btn btn-default btn-sm" onclick="javascript:onduration(8)">
                              <span class="glyphicon keyboard-08"></span>
                            </button>
                            <button type="button" class="btn btn-default btn-sm" onclick="javascript:onduration(6)">
                              <span class="glyphicon keyboard-16"></span>
                            </button>
                            <button type="button" class="btn btn-default btn-sm" onclick="javascript:onduration(3)">
                              <span class="glyphicon keyboard-32"></span>
                            </button>
                            <button type="button" class="btn btn-default btn-sm" onclick="javascript:onduration(5)">
                              <span class="glyphicon keyboard-64"></span>
                            </button>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-default btn-sm" onclick="javascript:onrest()">
                              <span class="glyphicon keyboard-rest"></span>
                            </button>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-default btn-sm" onclick="javascript:ondot()">
                              <span class="glyphicon keyboard-dot"></span>
                            </button>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-default btn-sm" onclick="javascript:onbarline()">
                              <span class="glyphicon keyboard-barline"></span>
                            </button>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="keyboard keyboard-center">
                          <map id="piano_map" name="piano_map">
                            <area shape="rect" coords="17,3,32,52" href="javascript:onpitch('C', 1, 1, 61)" />
                            <area shape="rect" coords="42,3,57,52" href="javascript:onpitch('D', 1, 1, 63)" />
                            <area shape="rect" coords="92,3,107,52" href="javascript:onpitch('F', 1, 1, 66)" />
                            <area shape="rect" coords="117,3,132,52" href="javascript:onpitch('G', 1, 1, 68)" />
                            <area shape="rect" coords="142,3,157,52" href="javascript:onpitch('A', 1, 1, 70)" />

                            <area shape="rect" coords="17,53,32,102" href="javascript:onpitch('D', 1, -1, 61)" />
                            <area shape="rect" coords="42,53,57,102" href="javascript:onpitch('E', 1, -1, 63)" />
                            <area shape="rect" coords="92,53,107,102" href="javascript:onpitch('G', 1, -1, 66)" />
                            <area shape="rect" coords="117,53,132,102" href="javascript:onpitch('A', 1, -1, 68)" />
                            <area shape="rect" coords="142,53,157,102" href="javascript:onpitch('B', 1, -1, 70)" />

                            <area shape="rect" coords="1,3,25,152" href="javascript:onpitch('C', 1, 0, 60)" />
                            <area shape="rect" coords="26,3,50,152" href="javascript:onpitch('D', 1, 0, 62)" />
                            <area shape="rect" coords="51,3,75,152" href="javascript:onpitch('E', 1, 0, 64)" />
                            <area shape="rect" coords="76,3,100,152" href="javascript:onpitch('F', 1, 0, 65)" />
                            <area shape="rect" coords="101,3,125,152" href="javascript:onpitch('G', 1, 0, 67)" />
                            <area shape="rect" coords="126,3,150,152" href="javascript:onpitch('A', 1, 0, 69)" />
                            <area shape="rect" coords="151,3,175,152" href="javascript:onpitch('B', 1, 0, 71)" />

                            <area shape="rect" coords="192,3,207,52" href="javascript:onpitch('C', 2, 1, 73)" />
                            <area shape="rect" coords="217,3,232,52" href="javascript:onpitch('D', 2, 1, 75)" />
                            <area shape="rect" coords="267,3,282,52" href="javascript:onpitch('F', 2, 1, 78)" />
                            <area shape="rect" coords="292,3,307,52" href="javascript:onpitch('G', 2, 1, 80)" />
                            <area shape="rect" coords="317,3,332,52" href="javascript:onpitch('A', 2, 1, 82)"  />

                            <area shape="rect" coords="192,53,207,102" href="javascript:onpitch('D', 2, -1, 73)" />
                            <area shape="rect" coords="217,53,232,102" href="javascript:onpitch('E', 2, -1, 75)" />
                            <area shape="rect" coords="267,53,282,102" href="javascript:onpitch('G', 2, -1, 78)" />
                            <area shape="rect" coords="292,53,307,102" href="javascript:onpitch('A', 2, -1, 80)" />
                            <area shape="rect" coords="317,53,332,102" href="javascript:onpitch('B', 2, -1, 82)" />

                            <area shape="rect" coords="176,3,200,152" href="javascript:onpitch('C', 2, 0, 72)" />
                            <area shape="rect" coords="201,3,225,152" href="javascript:onpitch('D', 2, 0, 74)" />
                            <area shape="rect" coords="226,3,250,152" href="javascript:onpitch('E', 2, 0, 76)" />
                            <area shape="rect" coords="251,3,275,152" href="javascript:onpitch('F', 2, 0, 77)" />
                            <area shape="rect" coords="276,3,300,152" href="javascript:onpitch('G', 2, 0, 79)" />
                            <area shape="rect" coords="301,3,325,152" href="javascript:onpitch('A', 2, 0, 81)" />
                            <area shape="rect" coords="326,3,350,152" href="javascript:onpitch('B', 2, 0, 83)" />


                            <area shape="rect" coords="367,3,382,52" href="javascript:onpitch('C', 3, 1, 85)" />
                            <area shape="rect" coords="392,3,407,52" href="javascript:onpitch('D', 3, 1, 87)" />
                            <area shape="rect" coords="442,3,457,52" href="javascript:onpitch('F', 3, 1, 90)" />
                            <area shape="rect" coords="467,3,482,52" href="javascript:onpitch('G', 3, 1, 92)" />
                            <area shape="rect" coords="492,3,507,52" href="javascript:onpitch('A', 3, 1, 94)" />

                            <area shape="rect" coords="367,53,382,102" href="javascript:onpitch('D', 3, -1, 85)" />
                            <area shape="rect" coords="392,53,407,102" href="javascript:onpitch('E', 3, -1, 87)" />
                            <area shape="rect" coords="442,53,457,102" href="javascript:onpitch('G', 3, -1, 90)" />
                            <area shape="rect" coords="467,53,482,102" href="javascript:onpitch('A', 3, -1, 92)" />
                            <area shape="rect" coords="492,53,507,102" href="javascript:onpitch('B', 3, -1, 94)" />

                            <area shape="rect" coords="351,3,375,152" href="javascript:onpitch('C', 3, 0, 84)" />
                            <area shape="rect" coords="376,3,400,152" href="javascript:onpitch('D', 3, 0, 86)" />
                            <area shape="rect" coords="401,3,425,152" href="javascript:onpitch('E', 3, 0, 88)" />
                            <area shape="rect" coords="426,3,450,152" href="javascript:onpitch('F', 3, 0, 89)" />
                            <area shape="rect" coords="451,3,475,152" href="javascript:onpitch('G', 3, 0, 91)" />
                            <area shape="rect" coords="476,3,500,152" href="javascript:onpitch('A', 3, 0, 93)" />
                            <area shape="rect" coords="501,3,525,152" href="javascript:onpitch('B', 3, 0, 95)" />
                        </map>
                        <img alt="piano keyboard" id="piano_img" src="{{ site.baseurl }}/images/piano.png" usemap="#piano_map"/>
                    </td>
                </tr>
                <tr>
                    <td class="keyboard">
                        <select id="clef_01" name="clef_01" class="form-control">
                            <option value="G-1">G-1</option>
                            <option value="G-2" selected="true">G-2 (treble)</option>
                            <option value="C-1">C-1</option>
                            <option value="C-2">C-2</option>
                            <option value="C-3">C-3</option>
                            <option value="C-4">C-4</option>
                            <option value="C-5">C-5</option>
                            <option value="F-4">F-4 (bass)</option>
                            <option value="F-3">F-3</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td class="keyboard">
                        <select id="keysig_01" name="keysig_01" class="form-control">
                            <option value="">Key signature ...</option>
                            <option value="xF">1 ♯</option>
                            <option value="xFC">2 ♯</option>
                            <option value="xFCG">3 ♯</option>
                            <option value="xFCGD">4 ♯</option>
                            <option value="xFCGDA">5 ♯</option>
                            <option value="xFCGDAE">6 ♯</option>
                            <option value="xFCGDAEB">7 ♯</option>
                            <option value="bB">1 ♭</option>
                            <option value="bBE">2 ♭</option>
                            <option value="bBEA">3 ♭</option>
                            <option value="bBEAD">4 ♭</option>
                            <option value="bBEADG">5 ♭</option>
                            <option value="bBEADGC">6 ♭</option>
                            <option value="bBEADGCF">7 ♭</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td class="keyboard">
                        <input type="input" id="timesig_01" name="timesig_01" class="form-control" placeholder="Time signature (e.g. c c/ 3/4)"/>
                    </td>
                </tr>
                <tr>
                    <td class="keyboard">
                        <textarea type="input" id="incipit_01" name="incipit_01" class="form-control" placeholder="Plaine &amp; Easie code …" ></textarea>
                        <div class="alert alert-warning" id="warnings_01" style="display: none;" role="alert"></div>
                    </td>
                </tr>
                <tr>
                    <td class="keyboard">
                        <div style="text-align: center;  display:inline;" id="render_01"></div>
                    </td>
                </tr>
            </table>
            </div>

            

            <div class="panel-body">
                 <pre class="prettyprint" id="mei_output"  style="overflow: auto; width: auto; word-wrap: normal; display: none;">
                 </pre>
            </div>
        </div>
    </div>
</div>

<script>
//<![CDATA[
    var soundPosition = 0;

    /*
    soundManager.url = '/swf/';
    //soundManager.flashVersion = 9; // optional: shiny features (default = 8)

    soundManager.onready(function() {
      if (soundManager.supported()) {
        // SM2 is ready to go!
        soundManager.createSound({
          id: 'scale',
          url: '/sound/scale_2-4.5.mp3',
          autoLoad: true,
          autoPlay: false,
          onload: function() {
            //alert('The sound '+this.sID+' loaded!');
          },
          whileplaying: function() {
            //console.log(this.position);
            if (this.position >= (soundPosition + 750)) {
                soundManager.stopAll();
            }
          }
        });
      } else {
        // unsupported/error case
      }
    });*/

    // global variables for the music notation
    var current_oct = -1;
    var current_duration = 4;
    var current_dot = 0;
    var undos = new Array();

    // reset the incipit
    function clear_incipit() {
        $('#incipit_01').val('');
        $("#incipit_01").trigger("input");
        current_oct = -1;
        reset_undos();
        update_incipit();
    }

    // function called from the SVG keyboard
    function onpitch(pitch, oct, alteration, midi)
    {
        //soundManager.stopAll();
        //soundPosition = (midi - 60) * 800 + 5;
        //soundManager.setPosition('scale', (midi - 60) * 80 )
        //soundManager.play('scale', {position: soundPosition} );
        //alert( (midi - 64) * 80 );

        pitch_str = '';
        if (oct != current_oct) {
          switch (oct) {
             case 3:
             pitch_str += '\'';
             case 2:
             pitch_str += '\'';
             case 1:
             pitch_str += '\'';
          }
        }
        current_oct = oct;
        switch (alteration) {
            /*
             case 0:
             pitch_str += 'n';
             break;
            */
             case 1:
             pitch_str += 'x';
             break;
             case -1:
             pitch_str += 'b';
             break;
        }

            pitch_str += current_duration;
            if (current_dot == 1) {
                pitch_str += '.';
            }

        pitch_str += pitch;
        undos.push( $('#incipit_01').val() );
        $('#incipit_01').val($('#incipit_01').val() + pitch_str );
        $("#incipit_01").trigger("input");
        update_incipit();
        activate_buttons();

    }

    function reset_undos( )
    {
        undos = []
    }

    function activate_buttons( ) {
        // this is a hack: we set the focus on the kb-focus link (arbitrarily) so we can process
        // keystroke events for changing the duration with the keyboard
        $('#kb_focus').focus();
    }

    function onduration( value )
    {
        current_duration = value;
        update_buttons();
    }

    function ondot(  )
    {
        if (current_dot == 0) {    current_dot = 1; }
        else { current_dot = 0; }
        update_buttons();
    }

    function onrest( )
    {
        rest_str = current_duration;
        rest_str += '-';
        undos.push( $('#incipit_01').val() );
        $('#incipit_01').val($('#incipit_01').val() + rest_str );
        $("#incipit_01").trigger("input");
        update_incipit();
        activate_buttons();
    }

    function onbarline( )
    {
        undos.push( $('#incipit_01').val() );
        $('#incipit_01').val($('#incipit_01').val() + '/' );
        $("#incipit_01").trigger("input");
        update_incipit();
        activate_buttons();
    }

    function onundo( )
    {
        undo_str = undos.pop()
        $('#incipit_01').val( undo_str );
        $("#incipit_01").trigger("input");
        update_incipit();
        activate_buttons();

    }

    // update the incipit and handle the timer - do not update if already updating
    function update_incipit()
    {
        //$('#incipit_01').val('4'+ $('#incipit_01').val());
        if ($('#incipit_01').val() == '') {
            // reset the octave if nothing in the incipit
            current_oct = -1
            $('#btn_clear_incipit').hide();
        } else {
            $('#btn_clear_incipit').show();
        }

        update_display();
    }

    // actually updating
    function update_display()
    {
        pe_incipit('',
                        "clef_01",
                        "keysig_01",
                        "timesig_01",
                        "incipit_01",
                        "render_01");
    }

    function update_buttons()
    {
        $(".kb").removeClass("ui-state-active");
        $(".kb").addClass("ui-state-default");
        if (current_duration == 9) { $('#kb-00').addClass("ui-state-active"); }
        else if (current_duration == 1) { $('#kb-01').addClass("ui-state-active"); }
        else if (current_duration == 2) { $('#kb-02').addClass("ui-state-active"); }
        else if (current_duration == 4) { $('#kb-04').addClass("ui-state-active"); }
        else if (current_duration == 8) { $('#kb-08').addClass("ui-state-active"); }
        else if (current_duration == 6) { $('#kb-16').addClass("ui-state-active"); }
        else if (current_duration == 3) { $('#kb-32').addClass("ui-state-active"); }
        else if (current_duration == 5) { $('#kb-64').addClass("ui-state-active"); }
        // dot
        if (current_dot == 1) { $('#kb-dot').addClass("ui-state-active"); }
    }

    // keyup event for updating when the text input is modified
    $('#incipit_01').keyup(function(event){
        update_incipit();
    });

    $('#clef_01').change(function(event){
        $("#incipit_01").trigger("input");
        update_incipit();
    });

    $('#keysig_01').change(function(event){
        $("#incipit_01").trigger("input");
        update_incipit();
    });

    $('#timesig_01').keyup(function(event){
        $("#incipit_01").trigger("input");
        update_incipit();
    });

    // keydown events for shortcuts to the buttons - only when #kb_focus (empty) has focus (hacky)
    $('#kb_focus').keypress(function(event) {
        if (event.charCode == 57) { onduration(9); } // 9
        else if (event.charCode == 49) { onduration(1); } // 1
        else if (event.charCode == 50) { onduration(2); } // 2
        else if (event.charCode == 52) { onduration(4); } // 4
        else if (event.charCode == 56) { onduration(8); } // 8
        else if (event.charCode == 54) { onduration(6); } // 6
        else if (event.charCode == 51) { onduration(3); } // 3
        else if (event.charCode == 53) { onduration(5); } // 5
        // rest
        else if ((event.charCode == 82) || (event.charCode == 114) || (event.charCode == 45)) { onrest(); }
        // dot
        else if ((event.charCode == 68) || (event.charCode == 100) || (event.charCode == 46)) { ondot(); }
        // barline
        else if ((event.charCode == 66) || (event.charCode == 98) || (event.charCode == 47)) { onbarline(); }
        // undo
        else if ((event.charCode == 85) || (event.charCode == 117)) { onundo(); }
    });

    if ($('#incipit_01').val() != "") {
        update_incipit();
    }

    update_buttons();
    activate_buttons();

    var vrvToolkit = new verovio.toolkit();


    function render_music( music, format )
    {
        // The trailing newline is needed so we can read the file lines
        // correctly if the file does not end with a newline
        var svg = vrvToolkit.renderData(music + "\n", {
            inputFrom: 'pae', 
            scale: 50, 
            adjustPageHeight: 1, 
            pageWidth: 1048, 
            pageMarginTop: 0, 
            pageMarginBottom: 0, 
            pageMarginLeft: 0, 
            pageMarginRight: 0, 
            spacingStaff: 2,
            xmlIdSeed: 1
        });
        document.getElementById('render_01').innerHTML = svg;

        var mei = vrvToolkit.getMEI( { "pageNo": 1, "scoreBased": true } );
        //var parser = new DOMParser();
        $("#mei_output").show();
        $("#mei_output").text(mei);
        //var innerMei = parser.parseFromString(mei, "text/xml");
        //document.getElementById('mei_output').innerHTML = innerMei;
        //console.log( mei );


    };

    function pe_incipit(destination_column, clef, keysig, timesig, incipit, target)
    {
        jquery_clef = clef.replace(/(\[|\])/g, '\\$1');
        jquery_keysig = keysig.replace(/(\[|\])/g, '\\$1');
        jquery_timesig = timesig.replace(/(\[|\])/g, '\\$1');
        jquery_incipit = incipit.replace(/(\[|\])/g, '\\$1');

        pae_clef = $('#' + jquery_clef).val();
        pae_keysig =  $('#' + jquery_keysig).val();
        pae_timesig = $('#' + jquery_timesig).val();
        pae_incipit = $('#' + jquery_incipit).val();

        pae = "@clef:" + pae_clef + "\n";
        pae = pae + "@keysig:" + pae_keysig + "\n";
        pae = pae + "@key:\n";
        pae = pae + "@timesig:" + pae_timesig + "\n";
        pae = pae + "@data: " + pae_incipit + "\n";
        render_music(pae, 'pae');

    }

    function getParameterByName(name) {
        var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
        return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
    }

    function onValidatePAE(input) {

        if (input == '') {
            $('#warnings_01').hide();
            return;
        }

        pae = "@clef:" + $('#clef_01').val() + "\n";
        pae = pae + "@keysig:" + $('#keysig_01').val() + "\n";
        pae = pae + "@timesig:" + $('#timesig_01').val() + "\n";
        pae = pae + "@data: " + $('#incipit_01').val() + "\n";

        highlights = [];
        messages = []
        validation = vrvToolkit.validatePAE(pae);
        //console.log("Validate", validation);
        if (validation.hasOwnProperty("text")) {
            messages.push(validation["text"]);
        }
        if (validation.hasOwnProperty("clef")) {
            messages.push(validation["clef"]["text"]);
        }
        if (validation.hasOwnProperty("keysig")) {
            messages.push(validation["keysig"]["text"]);
        }
        if (validation.hasOwnProperty("timesig")) {
            messages.push(validation["timesig"]["text"]);
        }
        if (validation.hasOwnProperty("data")) {
            data = validation["data"];
            //console.log(data);
            for (i = 0; i < data.length; i++) {
                messages.push(data[i]["text"]);
                j = data[i]["column"];
                if (j > 0) highlights.push([j - 1, j]);
            }
        }
        if (messages.length > 0) {
            $('#warnings_01').html(messages.join("<br/>"));
            $('#warnings_01').show();
        }
        else {
            $('#warnings_01').hide();
        }
        //console.log(highlights);
        return [highlights];
    }

    $( document ).ready(function() {

        // Load the default file or the file passed in the URL
        var pae = getParameterByName("pae");
        console.log(pae);

        if (pae != "") {
            $("#incipit_01").val(pae);
            update_incipit();
        }

        $("#incipit_01").highlightWithinTextarea({ highlight: onValidatePAE });
    });


//]]>
</script>
